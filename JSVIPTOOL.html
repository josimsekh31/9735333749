<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Tool Box</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* Iframe Viewer Transition */
        .viewer-enter {
            transform: translateY(100%);
            opacity: 0;
        }
        .viewer-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s ease-in-out;
        }
        .viewer-exit {
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .dark .glass-panel {
            background: rgba(31, 41, 55, 0.9);
        }
        
        /* Tool Card Hover */
        .tool-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-light text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 font-sans overflow-x-hidden">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkndE5h7HOLTg2xEs7mgKimJIwodApFJs",
            authDomain: "andronix-bcdf7.firebaseapp.com",
            databaseURL: "https://andronix-bcdf7-default-rtdb.firebaseio.com",
            projectId: "andronix-bcdf7",
            storageBucket: "andronix-bcdf7.appspot.com",
            messagingSenderId: "982083836381",
            appId: "1:982083836381:web:1a36b6a925eb0d53e73e34",
            measurementId: "G-F5KLB4PEXT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Environment Variable for Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'js-toolbox-default';

        // Expose to window for UI logic
        window.db = db;
        window.auth = auth;
        window.storage = storage;
        window.appId = appId;
        
        // Firestore Helper Functions exposed
        window.fs = {
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, onSnapshot, where
        };

        // Auth Init
        window.initAuth = async () => {
             // For this demo, we allow anonymous sign in to fetch public data if not logged in
             // But we will primarily use Email/Pass for the user features
        };
        
        // Listen for Auth State
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            updateAuthUI(user);
            if(user) {
                checkUserBlockStatus(user.uid);
            }
        });
    </script>

    <!-- App Container -->
    <div id="app" class="relative min-h-screen flex flex-col">

        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white dark:bg-gray-800 shadow-md">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="menuBtn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2 cursor-pointer" onclick="router.navigate('home')">
                        <div class="w-8 h-8 bg-primary rounded flex items-center justify-center text-white font-bold">JS</div>
                        <h1 class="text-xl font-bold tracking-tight hidden sm:block">Tool Box</h1>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="hidden md:flex flex-1 max-w-lg mx-4">
                    <div class="relative w-full">
                        <input type="text" id="searchInput" placeholder="Search tools..." 
                            class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <!-- Language Selector -->
                    <select id="langSelect" class="bg-transparent border-none text-sm font-medium focus:ring-0 cursor-pointer">
                        <option value="en">EN</option>
                        <option value="hi">HI</option>
                        <option value="bn">BN</option>
                    </select>

                    <!-- Theme Toggle -->
                    <button id="themeBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-moon"></i>
                    </button>

                    <!-- Auth/Profile -->
                    <div id="authContainer">
                        <button onclick="ui.showModal('authModal')" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Login
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Search (Visible only on small screens) -->
            <div class="md:hidden px-4 pb-3">
                <div class="relative w-full">
                    <input type="text" id="mobileSearchInput" placeholder="Search tools..." 
                        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
        </header>

        <!-- Sidebar Drawer -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity"></div>
        <aside id="sidebar" class="fixed top-0 left-0 bottom-0 w-72 bg-white dark:bg-gray-800 z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <span class="font-bold text-lg">Menu</span>
                <button id="closeSidebar" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto py-4">
                <!-- Admin Link (Hidden by default) -->
                <a href="#" onclick="ui.showModal('adminLoginModal')" class="block px-6 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-red-500 font-medium">
                    <i class="fas fa-user-shield w-6"></i> Admin Login
                </a>
                
                <div id="dynamicMenu">
                    <!-- Categories will be injected here -->
                </div>

                <div class="mt-4 border-t dark:border-gray-700 pt-4">
                    <p class="px-6 text-xs font-semibold text-gray-500 uppercase mb-2">Legal</p>
                    <a href="#" onclick="router.navigate('page-privacy')" class="block px-6 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">Privacy Policy</a>
                    <a href="#" onclick="router.navigate('page-disclaimer')" class="block px-6 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">Disclaimer</a>
                    <a href="#" onclick="router.navigate('page-about')" class="block px-6 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">About Us</a>
                    <a href="#" onclick="router.navigate('page-contact')" class="block px-6 py-2 hover:bg-gray-50 dark:hover:bg-gray-700">Contact Us</a>
                </div>
            </div>

            <div class="p-4 border-t dark:border-gray-700 text-center">
                <a href="https://about.me/josimsekh" target="_blank" class="text-sm text-primary hover:underline">Created by Josim Sekh</a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="mainContent" class="flex-1 container mx-auto px-4 py-6 relative">
            
            <!-- VIEW: HOME (Tool Grid) -->
            <div id="view-home" class="page-view animate-fade-in">
                <!-- Categories Chips -->
                <div id="categoryFilters" class="flex gap-2 overflow-x-auto pb-4 mb-4 hide-scrollbar">
                    <button class="bg-primary text-white px-4 py-1 rounded-full text-sm whitespace-nowrap">All</button>
                    <!-- Injected via JS -->
                </div>

                <!-- Tools Grid -->
                <div id="toolsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Tools injected here -->
                    <div class="col-span-full text-center py-20 text-gray-500">
                        <div class="loader mx-auto mb-4"></div>
                        <p>Loading Tools...</p>
                    </div>
                </div>

                <!-- JS More Tool Section -->
                <div class="mt-12 bg-blue-50 dark:bg-gray-800 rounded-xl p-6 text-center border border-blue-100 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-2">Want more JS Tools?</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Check out our extended collection or request a tool.</p>
                    <button onclick="router.navigate('page-contact')" class="bg-dark text-white dark:bg-white dark:text-dark px-6 py-2 rounded-lg font-medium">Request Tool</button>
                </div>
            </div>

            <!-- VIEW: STATIC PAGES -->
            <div id="view-page" class="page-view hidden max-w-3xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow">
                <h1 id="pageTitle" class="text-3xl font-bold mb-6"></h1>
                <div id="pageContent" class="prose dark:prose-invert"></div>
            </div>

            <!-- VIEW: ADMIN PANEL -->
            <div id="view-admin" class="page-view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-500"><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                    <button onclick="admin.logout()" class="text-sm bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded">Logout</button>
                </div>

                <!-- Admin Tabs -->
                <div class="flex border-b dark:border-gray-700 mb-6">
                    <button onclick="admin.switchTab('tools')" class="admin-tab px-4 py-2 border-b-2 border-primary font-medium">Tools</button>
                    <button onclick="admin.switchTab('users')" class="admin-tab px-4 py-2 border-b-2 border-transparent hover:border-gray-300">Users</button>
                    <button onclick="admin.switchTab('categories')" class="admin-tab px-4 py-2 border-b-2 border-transparent hover:border-gray-300">Categories</button>
                </div>

                <!-- Tab: Tools -->
                <div id="admin-tab-tools" class="admin-content">
                    <button onclick="ui.showModal('toolModal')" class="mb-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus"></i> Add New Tool
                    </button>
                    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded shadow">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Image</th>
                                    <th class="px-4 py-3">Title</th>
                                    <th class="px-4 py-3">Category</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminToolTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Users -->
                <div id="admin-tab-users" class="admin-content hidden">
                    <div class="bg-white dark:bg-gray-800 rounded shadow overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">User ID/Email</th>
                                    <th class="px-4 py-3">Status</th>
                                    <th class="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="adminUserTable"></tbody>
                        </table>
                    </div>
                </div>
                
                 <!-- Tab: Categories -->
                <div id="admin-tab-categories" class="admin-content hidden">
                     <button onclick="ui.showModal('catModal')" class="mb-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                    <ul id="adminCatList" class="bg-white dark:bg-gray-800 rounded shadow divide-y dark:divide-gray-700"></ul>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 py-6 mt-8">
            <div class="container mx-auto px-4 text-center">
                <p class="text-sm text-gray-500">&copy; 2025 JS Tool Box. All rights reserved.</p>
                <div class="flex justify-center gap-4 mt-2">
                    <a href="https://about.me/josimsekh" class="text-gray-400 hover:text-primary"><i class="fas fa-globe"></i></a>
                    <a href="mailto:sekhjosim31@gmail.com" class="text-gray-400 hover:text-primary"><i class="fas fa-envelope"></i></a>
                </div>
            </div>
        </footer>

        <!-- WhatsApp Float -->
        <a href="https://wa.me/916296384610" target="_blank" class="fixed bottom-6 right-6 z-30 bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-110 flex items-center justify-center">
            <i class="fab fa-whatsapp text-2xl"></i>
        </a>
    </div>

    <!-- IFRAME VIEWER (Overlay) -->
    <div id="toolViewer" class="fixed inset-0 z-50 bg-white dark:bg-gray-900 flex flex-col transform translate-y-full transition-transform duration-300">
        <div class="bg-primary text-white h-14 flex items-center justify-between px-4 shadow-lg shrink-0">
            <button onclick="viewer.close()" class="p-2 hover:bg-blue-600 rounded"><i class="fas fa-arrow-left"></i> Back</button>
            <h3 id="viewerTitle" class="font-bold truncate max-w-xs">Tool Name</h3>
            <div class="flex gap-2">
                <button onclick="viewer.refresh()" class="p-2 hover:bg-blue-600 rounded"><i class="fas fa-redo"></i></button>
                <button onclick="viewer.openExternal()" class="p-2 hover:bg-blue-600 rounded"><i class="fas fa-external-link-alt"></i></button>
            </div>
        </div>
        <div class="flex-1 relative w-full h-full bg-gray-100">
             <iframe id="mainFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" src=""></iframe>
             <div id="iframeLoader" class="absolute inset-0 flex items-center justify-center bg-white dark:bg-gray-800">
                 <div class="loader"></div>
             </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold mb-4 text-center">Admin Access</h2>
            <form onsubmit="admin.login(event)">
                <input type="text" id="admUser" placeholder="Username" class="w-full mb-3 p-3 rounded bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" required>
                <input type="password" id="admPass" placeholder="Password" class="w-full mb-3 p-3 rounded bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" required>
                <input type="password" id="admCode" placeholder="Secret Code" class="w-full mb-4 p-3 rounded bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" required>
                <button type="submit" class="w-full bg-red-500 text-white font-bold py-3 rounded hover:bg-red-600">Access Panel</button>
            </form>
            <button onclick="ui.hideModal('adminLoginModal')" class="mt-4 w-full text-gray-500 text-sm">Cancel</button>
        </div>
    </div>

    <!-- Auth Modal (Login/Signup) -->
    <div id="authModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6">
            <h2 id="authTitle" class="text-2xl font-bold mb-4 text-center">Login</h2>
            <form onsubmit="authHandler.submit(event)">
                <input type="email" id="authUser" placeholder="Email" class="w-full mb-3 p-3 rounded bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" required>
                <input type="password" id="authPass" placeholder="Password" class="w-full mb-4 p-3 rounded bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600" required>
                <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded hover:bg-blue-600">Go</button>
            </form>
            <p class="mt-4 text-center text-sm">
                <span id="authSwitchText" class="text-gray-500 cursor-pointer hover:text-primary" onclick="authHandler.toggleMode()">New here? Create account</span>
            </p>
            <button onclick="ui.hideModal('authModal')" class="mt-2 w-full text-gray-500 text-sm">Close</button>
        </div>
    </div>

    <!-- Add/Edit Tool Modal -->
    <div id="toolModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 p-4 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-lg p-6 my-8">
            <h3 class="text-xl font-bold mb-4">Manage Tool</h3>
            <form onsubmit="admin.saveTool(event)">
                <input type="hidden" id="toolId">
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="toolTitle" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Description (Mini)</label>
                    <input type="text" id="toolDesc" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Tool URL (https://...)</label>
                    <input type="url" id="toolUrl" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Category</label>
                    <select id="toolCategory" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Image URL</label>
                    <input type="url" id="toolImage" placeholder="https://example.com/image.png" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Or drag & drop functionality (simulated)</p>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="ui.hideModal('toolModal')" class="px-4 py-2 text-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded">Save Tool</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Add Category Modal -->
    <div id="catModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Add Category</h3>
            <form onsubmit="admin.saveCat(event)">
                <input type="text" id="catName" placeholder="Category Name" class="w-full p-2 rounded border dark:bg-gray-700 mb-4" required>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="ui.hideModal('catModal')" class="px-4 py-2 text-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * GLOBAL STATE & CONSTANTS
         */
        const state = {
            isAdmin: false,
            lang: 'en',
            tools: [],
            categories: [],
            filter: 'All',
            search: '',
            isAuthModeLogin: true // Toggle between login/signup
        };

        const translations = {
            en: { home: "Home", about: "About Us", contact: "Contact", privacy: "Privacy Policy", disclaimer: "Disclaimer" },
            hi: { home: "होम", about: "हमारे बारे में", contact: "संपर्क करें", privacy: "गोपनीयता नीति", disclaimer: "अस्वीकरण" },
            bn: { home: "হোম", about: "আমাদের সম্পর্কে", contact: "যোগাযোগ", privacy: "গোপনীয়তা নীতি", disclaimer: "দাবিত্যাগ" }
        };

        /**
         * UI HANDLER
         */
        const ui = {
            toggleSidebar: () => {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sb.classList.contains('-translate-x-full')) {
                    sb.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },
            closeSidebar: () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            },
            toggleTheme: () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.querySelector('#themeBtn i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            },
            showModal: (id) => document.getElementById(id).classList.remove('hidden'),
            hideModal: (id) => document.getElementById(id).classList.add('hidden'),
            showToast: (msg, type='info') => {
                // Simple Alert Replacement
                const toast = document.createElement('div');
                toast.className = `fixed top-20 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white animate-fade-in ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
                toast.innerText = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };

        /**
         * ROUTER SIMULATION
         */
        const router = {
            navigate: (viewId) => {
                // Hide all views
                document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
                ui.closeSidebar();

                if (viewId.startsWith('page-')) {
                    // Static Pages
                    const pageKey = viewId.replace('page-', '');
                    document.getElementById('view-page').classList.remove('hidden');
                    renderStaticPage(pageKey);
                } else {
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                }
                window.scrollTo(0,0);
            }
        };

        function renderStaticPage(key) {
            const titleEl = document.getElementById('pageTitle');
            const contentEl = document.getElementById('pageContent');
            const data = {
                privacy: { t: "Privacy Policy", c: "<p>We respect your privacy. This app collects basic usage data for improvement.</p>" },
                disclaimer: { t: "Disclaimer", c: "<p>Tools provided are for educational purposes. We are not responsible for misuse.</p>" },
                about: { t: "About Us", c: "<p>JS Tool Box is a comprehensive suite of JavaScript utilities built by Josim Sekh.</p>" },
                contact: { t: "Contact Us", c: "<p>Email: sekhjosim31@gmail.com</p><p>WhatsApp: +916296384610</p>" }
            };
            if(data[key]) {
                titleEl.innerText = data[key].t;
                contentEl.innerHTML = data[key].c;
            }
        }

        /**
         * AUTHENTICATION HANDLER
         */
        const authHandler = {
            toggleMode: () => {
                state.isAuthModeLogin = !state.isAuthModeLogin;
                document.getElementById('authTitle').innerText = state.isAuthModeLogin ? "Login" : "Create Account";
                document.getElementById('authSwitchText').innerText = state.isAuthModeLogin ? "New here? Create account" : "Already have an account? Login";
            },
            submit: async (e) => {
                e.preventDefault();
                const email = document.getElementById('authUser').value;
                const pass = document.getElementById('authPass').value;
                const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.auth.constructor.prototype ? window.auth : window; // Fallback for scope
                
                try {
                    let cred;
                    if(state.isAuthModeLogin) {
                        cred = await window.auth.signInWithEmailAndPassword(email, pass);
                        ui.showToast("Logged in successfully");
                    } else {
                        cred = await window.auth.createUserWithEmailAndPassword(email, pass);
                        // Create user profile in Firestore
                        await window.fs.setDoc(window.fs.doc(window.db, `artifacts/${window.appId}/users/${cred.user.uid}/profile`, 'info'), {
                            email: email,
                            role: 'user',
                            isBlocked: false,
                            joined: new Date().toISOString()
                        });
                        ui.showToast("Account created!");
                    }
                    ui.hideModal('authModal');
                } catch (err) {
                    ui.showToast(err.message, 'error');
                }
            },
            logout: () => {
                window.auth.signOut();
                state.isAdmin = false;
                router.navigate('home');
                ui.showToast("Logged out");
            }
        };

        function updateAuthUI(user) {
            const container = document.getElementById('authContainer');
            if (user) {
                container.innerHTML = `<button onclick="authHandler.logout()" class="text-sm text-red-500 font-medium">Logout</button>`;
            } else {
                container.innerHTML = `<button onclick="ui.showModal('authModal')" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Login</button>`;
            }
        }

        /**
         * ADMIN SYSTEM (SECURE)
         */
        const admin = {
            login: (e) => {
                e.preventDefault();
                const u = document.getElementById('admUser').value;
                const p = document.getElementById('admPass').value;
                const c = document.getElementById('admCode').value;

                if (u === 'josimsekh31' && p === 'josimsv1' && c === '191355') {
                    state.isAdmin = true;
                    ui.hideModal('adminLoginModal');
                    ui.showToast("Admin Access Granted");
                    router.navigate('admin');
                    admin.loadData();
                } else {
                    ui.showToast("Invalid Credentials", 'error');
                }
            },
            logout: () => {
                state.isAdmin = false;
                router.navigate('home');
                ui.showToast("Admin Logout");
            },
            switchTab: (tabName) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('border-primary'));
                document.getElementById(`admin-tab-${tabName}`).classList.remove('hidden');
                event.target.classList.add('border-primary');
            },
            loadData: () => {
                if(!state.isAdmin) return;
                // Render Admin Tables
                renderAdminTools();
                renderAdminUsers();
                renderAdminCategories();
            },
            saveTool: async (e) => {
                e.preventDefault();
                const id = document.getElementById('toolId').value;
                const toolData = {
                    title: document.getElementById('toolTitle').value,
                    desc: document.getElementById('toolDesc').value,
                    url: document.getElementById('toolUrl').value,
                    category: document.getElementById('toolCategory').value,
                    image: document.getElementById('toolImage').value || 'https://via.placeholder.com/300x200?text=JS+Tool'
                };

                try {
                    if (id) {
                        await window.fs.updateDoc(window.fs.doc(window.db, `artifacts/${window.appId}/public/data/tools`, id), toolData);
                        ui.showToast("Tool Updated");
                    } else {
                        await window.fs.addDoc(window.fs.collection(window.db, `artifacts/${window.appId}/public/data/tools`), toolData);
                        ui.showToast("Tool Added");
                    }
                    ui.hideModal('toolModal');
                } catch (err) {
                    ui.showToast("Error saving tool", 'error');
                }
            },
            saveCat: async (e) => {
                e.preventDefault();
                const name = document.getElementById('catName').value;
                try {
                     await window.fs.addDoc(window.fs.collection(window.db, `artifacts/${window.appId}/public/data/categories`), { name });
                     ui.showToast("Category Added");
                     ui.hideModal('catModal');
                } catch(err) {
                    ui.showToast("Error", 'error');
                }
            },
            deleteItem: async (collectionName, id) => {
                if(!confirm("Are you sure?")) return;
                try {
                    await window.fs.deleteDoc(window.fs.doc(window.db, `artifacts/${window.appId}/public/data/${collectionName}`, id));
                    ui.showToast("Deleted");
                } catch(err) {
                     ui.showToast("Error deleting", 'error');
                }
            }
        };

        /**
         * DATA FETCHING & RENDERING (USER SIDE)
         */
        async function fetchInitialData() {
            // 1. Categories
            const catQuery = window.fs.query(window.fs.collection(window.db, `artifacts/${window.appId}/public/data/categories`));
            window.fs.onSnapshot(catQuery, (snap) => {
                state.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderCategories();
                admin.loadData(); // Refresh admin if active
            }, (err) => console.log("Cat Error", err));

            // 2. Tools
            const toolQuery = window.fs.query(window.fs.collection(window.db, `artifacts/${window.appId}/public/data/tools`));
            window.fs.onSnapshot(toolQuery, (snap) => {
                state.tools = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTools();
                admin.loadData();
            }, (err) => console.log("Tool Error", err));
        }

        function renderCategories() {
            const container = document.getElementById('categoryFilters');
            const toolCatSelect = document.getElementById('toolCategory');
            
            // User filter chips
            let html = `<button onclick="filterTools('All')" class="px-4 py-1 rounded-full text-sm whitespace-nowrap transition-colors ${state.filter === 'All' ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300'}">All</button>`;
            
            // Admin select options
            let opts = `<option value="General">General</option>`;

            state.categories.forEach(c => {
                const isActive = state.filter === c.name;
                html += `<button onclick="filterTools('${c.name}')" class="px-4 py-1 rounded-full text-sm whitespace-nowrap transition-colors ${isActive ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300'}">${c.name}</button>`;
                opts += `<option value="${c.name}">${c.name}</option>`;
            });

            container.innerHTML = html;
            toolCatSelect.innerHTML = opts;
            
            // Sidebar menu injection
            const menuHtml = state.categories.map(c => `
                <a href="#" onclick="filterTools('${c.name}'); ui.closeSidebar();" class="block px-6 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                    <i class="fas fa-folder mr-2 text-primary"></i> ${c.name}
                </a>
            `).join('');
            document.getElementById('dynamicMenu').innerHTML = menuHtml;
        }

        function filterTools(cat) {
            state.filter = cat;
            renderCategories(); // Update active state
            renderTools();
        }

        function renderTools() {
            const grid = document.getElementById('toolsGrid');
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = state.tools.filter(t => {
                const matchesCat = state.filter === 'All' || t.category === state.filter;
                const matchesSearch = t.title.toLowerCase().includes(term) || t.desc.toLowerCase().includes(term);
                return matchesCat && matchesSearch;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">No tools found.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(t => `
                <div class="tool-card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col h-full cursor-pointer" onclick="viewer.open('${t.url}', '${t.title}')">
                    <div class="h-40 bg-gray-200 dark:bg-gray-700 relative overflow-hidden">
                        <img src="${t.image}" alt="${t.title}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-md">
                            ${t.category || 'General'}
                        </div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col">
                        <h3 class="font-bold text-lg mb-1 line-clamp-1">${t.title}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mb-3 flex-1">${t.desc}</p>
                        <button class="w-full bg-blue-50 dark:bg-gray-700 text-primary dark:text-blue-400 py-2 rounded-lg text-sm font-semibold hover:bg-blue-100 dark:hover:bg-gray-600 transition-colors">
                            Open Tool <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * IFRAME VIEWER
         */
        const viewer = {
            open: (url, title) => {
                const v = document.getElementById('toolViewer');
                const f = document.getElementById('mainFrame');
                const t = document.getElementById('viewerTitle');
                const l = document.getElementById('iframeLoader');
                
                t.innerText = title;
                f.src = url;
                v.classList.remove('translate-y-full');
                l.style.display = 'flex';
                
                f.onload = () => {
                    l.style.display = 'none';
                };
                
                // Track usage if needed
            },
            close: () => {
                document.getElementById('toolViewer').classList.add('translate-y-full');
                setTimeout(() => {
                     document.getElementById('mainFrame').src = '';
                }, 300);
            },
            refresh: () => {
                document.getElementById('mainFrame').contentWindow.location.reload();
            },
            openExternal: () => {
                const url = document.getElementById('mainFrame').src;
                if(url) window.open(url, '_blank');
            }
        };

        /**
         * ADMIN RENDER FUNCTIONS
         */
        function renderAdminTools() {
            const tbody = document.getElementById('adminToolTable');
            tbody.innerHTML = state.tools.map(t => `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-3"><img src="${t.image}" class="w-10 h-10 rounded object-cover"></td>
                    <td class="px-4 py-3 font-medium">${t.title}</td>
                    <td class="px-4 py-3 text-gray-500">${t.category}</td>
                    <td class="px-4 py-3 flex gap-2">
                        <button onclick="editTool('${t.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        <button onclick="admin.deleteItem('tools', '${t.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderAdminCategories() {
            const list = document.getElementById('adminCatList');
            list.innerHTML = state.categories.map(c => `
                 <li class="px-4 py-3 flex justify-between items-center">
                    <span>${c.name}</span>
                    <button onclick="admin.deleteItem('categories', '${c.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                 </li>
            `).join('');
        }
        
        // Mock User Fetch (Since we can't list all users easily in client SDK without Admin SDK or specific Firestore structure)
        // We will list users from the 'users' collection we created on signup
        function renderAdminUsers() {
             const userQuery = window.fs.query(window.fs.collection(window.db, `artifacts/${window.appId}/users`));
             // Note: In a real app this would query subcollections or a root users collection. 
             // We'll skip deep implementation here as client SDK cannot listAuthUsers.
             // This is a placeholder for the requested "User Management" logic
             document.getElementById('adminUserTable').innerHTML = `
                <tr><td colspan="3" class="p-4 text-center text-gray-500">
                    To manage users, they must sign up first. Then their profiles will appear here.
                    <br><small>(Requires specific Firestore structure setup on Signup)</small>
                </td></tr>
             `;
        }

        function editTool(id) {
            const t = state.tools.find(x => x.id === id);
            if(!t) return;
            document.getElementById('toolId').value = t.id;
            document.getElementById('toolTitle').value = t.title;
            document.getElementById('toolDesc').value = t.desc;
            document.getElementById('toolUrl').value = t.url;
            document.getElementById('toolCategory').value = t.category;
            document.getElementById('toolImage').value = t.image;
            ui.showModal('toolModal');
        }

        async function checkUserBlockStatus(uid) {
             // Logic to check if user is blocked in Firestore
             // If blocked -> Sign Out & Alert
        }

        /**
         * EVENT LISTENERS
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Theme Init
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
                document.querySelector('#themeBtn i').className = 'fas fa-sun';
            }

            // Bindings
            document.getElementById('menuBtn').addEventListener('click', ui.toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', ui.closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', ui.closeSidebar);
            document.getElementById('themeBtn').addEventListener('click', ui.toggleTheme);
            document.getElementById('searchInput').addEventListener('input', renderTools);
            document.getElementById('mobileSearchInput').addEventListener('input', (e) => {
                document.getElementById('searchInput').value = e.target.value;
                renderTools();
            });

            // Lang Logic (Simple text swap for demo)
            document.getElementById('langSelect').addEventListener('change', (e) => {
                state.lang = e.target.value;
                // Just for demo, we won't replace everything, but key elements could be swapped here
            });

            // Initial Data
            window.initAuth();
            fetchInitialData();
        });

    </script>
</body>
</html>

